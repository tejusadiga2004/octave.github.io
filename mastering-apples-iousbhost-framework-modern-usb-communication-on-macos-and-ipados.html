
<!DOCTYPE html>
<html lang="en">

<!-- Head -->
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-26R9CS17CT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-26R9CS17CT');
    </script>


        <!-- Required metadata tags -->
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="HandheldFriendly" content="True" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

        <!-- Default metadata -->
    <meta name="author" content="Tejus Adiga M" />
    <meta name="description" content="A comprehensive guide to Apple&#39;s IOUSBHost framework, covering the transition from KEXTs, when to use DriverKit vs IOUSBHost, and complete implementation examples for all USB transfer types in Swift." />
    <meta name="keywords" content="macOS, IOUSBHost, USB, Driver Development, DriverKit">
<meta property="og:site_name" content="Entropy Pages" />
<meta property="og:title" content="Mastering Apple&#39;s IOUSBHost Framework: Modern USB Communication on macOS and iPadOS" />
<meta property="og:description" content="A comprehensive guide to Apple&#39;s IOUSBHost framework, covering the transition from KEXTs, when to use DriverKit vs IOUSBHost, and complete implementation examples for all USB transfer types in Swift." />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://blogs.entropypages.in/mastering-apples-iousbhost-framework-modern-usb-communication-on-macos-and-ipados.html" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-06-28 10:00:00+05:30" />
<meta property="article:modified_time" content="" />
<meta property="article:author" content="https://blogs.entropypages.in/author/tejus-adiga-m.html">
<meta property="article:section" content="macOS" />
	<meta property="article:tag" content="macOS" />
	<meta property="article:tag" content="IOUSBHost" />
	<meta property="article:tag" content="USB" />
	<meta property="article:tag" content="Driver Development" />
	<meta property="article:tag" content="DriverKit" />
	<meta property="og:image" content="https://blogs.entropypages.in/images/SiteImage.png">

        <!-- Site Claim -->


        <!-- Title -->
        <title>
    Mastering Apple&#39;s IOUSBHost Framework: Modern USB Communication on macOS and iPadOS &ndash; Entropy Pages
        </title>
        
        <!-- Icon -->
        <link rel="shortcut icon" href="https://blogs.entropypages.in/favicon.ico" type="image/x-icon">
        <link rel="icon" href="https://blogs.entropypages.in/favicon.ico" type="image/x-icon">

        <!-- Search engine -->
            <meta name="robots" content="" />

        <!-- Feeds -->
            <link href="https://blogs.entropypages.in/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Entropy Pages Full Atom Feed" />




            <link href="https://blogs.entropypages.in/feeds/macos.atom.xml" type="application/atom+xml" rel="alternate" title="Entropy Pages Categories Atom Feed" />




        <!-- Styles -->
        <!--
        <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/css/bootstrap.min.css">
        -->
        <link rel="stylesheet" href="https://blogs.entropypages.in/theme/bootstrap/bootstrap.min.css">
        <!--
        <link rel="stylesheet" href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css">
        -->
        <link rel="stylesheet" href="https://blogs.entropypages.in/theme/pygment/friendly.css">
        <!--
        <link rel="stylesheet" href="https://blogs.entropypages.in/theme/extra/admonition.min.css">
        -->
        <link rel="stylesheet" href="https://blogs.entropypages.in/theme/style.css">
        
        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Sankofa+Display:wght@400&display=swap" rel="stylesheet">

        <!-- Google Analytics -->

        <!-- Google Global Site Tag -->

        <!-- Google Tag Manager -->

        <!-- Google Adsense -->

        <!-- Heap Analytic -->

        <!-- Piwik Tracking -->

        <!-- Matomo Tracking -->

        <!-- MathJax Support -->
        <script type="text/javascript">
            window.MathJax = {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']],
                    processEscapes: true,
                    processEnvironments: true,
                    packages: {'[+]': ['ams', 'newcommand', 'configmacros']},
                    macros: {
                        land: "\\wedge",
                        lor: "\\vee", 
                        lnot: "\\neg"
                    }
                },
                options: {
                    ignoreHtmlClass: 'tex2jax_ignore',
                    processHtmlClass: 'tex2jax_process'
                }
            };
        </script>
        <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js">
        </script>

</head>

<!-- Body -->
<body class="d-flex flex-column" data-spy="scroll" data-target="#toc" data-offset="0" style="position: relative;">
    <!-- Top anchor -->
    <a href="#" id="backToTop" style="display: none; z-index: 1;" title="Back to top"><span></span></a>

    <!-- Google tag manager -->

    <!-- Navigation -->
    <nav class="flex-shrink-0 navbar navbar-expand-md navbar-expand-lg navbar-dark bg-dark text-light shadow-sm">
        <!-- Logo -->
        <a class="navbar-brand site-name" href="https://blogs.entropypages.in/">Entropy Pages</a>

        <!-- Desktop divider -->
        <div class="navbar-divider d-none d-md-block"></div>

        <!-- Collapse button -->
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMenu" aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon small"></span>
        </button>

        <!-- Collapsible content -->
        <div class="collapse navbar-collapse" id="navbarMenu">

            <!-- i18n subsites -->

            <!-- Page links -->
            <ul class="navbar-nav mr-auto text-center">
                <li class="nav-item ">                           
                    <a class="nav-link" href="https://blogs.entropypages.in">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24">
                            <path d="M21 13v10h-6v-6h-6v6h-6v-10h-3l12-12 12 12h-3zm-1-5.907v-5.093h-3v2.093l3 3z" fill="currentColor"></path>
                        </svg>
                        Home <span class="sr-only">(current)</span>
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="https://blogs.entropypages.in/categories.html">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24">
                            <path d="M16 6h-8v-6h8v6zm-8 12h-8v6h8v-6zm16 0h-8v6h8v-6zm-11-7v-3h-2v3h-8v5h2v-3h14v3h2v-5h-8z" fill="currentColor"></path>
                        </svg>
                        Categories
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="https://blogs.entropypages.in/archives.html">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24">
                            <path d="M1.8 9l-.8-4h22l-.8 4h-2.029l.39-2h-17.122l.414 2h-2.053zm18.575-6l.604-2h-17.979l.688 2h16.687zm3.625 8l-2 13h-20l-2-13h24zm-8 4c0-.552-.447-1-1-1h-6c-.553 0-1 .448-1 1s.447 1 1 1h6c.553 0 1-.448 1-1z" fill="currentColor"></path>
                        </svg>
                        Archives
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="https://blogs.entropypages.in/pages/about.html">
                        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24">
                            <path d="M20.822 18.096c-3.439-.794-6.64-1.49-5.09-4.418 4.72-8.912 1.251-13.678-3.732-13.678-5.082 0-8.464 4.949-3.732 13.678 1.597 2.945-1.725 3.641-5.09 4.418-3.073.71-3.188 2.236-3.178 4.904l.004 1h23.99l.004-.969c.012-2.688-.092-4.222-3.176-4.935z" fill="currentColor"></path>
                        </svg>
                        About
                    </a>
                </li>
            </ul>

            <!-- Search form -->
            <form class="form-inline text-center" action="https://blogs.entropypages.in/pages/search.html">
                <input class="form-control w-100 bg-dark text-light text-center border-0 p-2" type="text" name="q" pattern=".{3,}" title="At least 3 characters" required="" placeholder="Type here to search" aria-label="Search">
            </form>

            <!-- Social links -->
            <ul class="navbar-nav text-center">
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <title>Facebook</title>
                            <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z" fill="currentColor"></path>
                        </svg>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://github.com/tejusadiga2004">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <title>Github</title>
                            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" fill="currentColor"></path>
                        </svg>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://www.linkedin.com/in/tejusadigam/">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <title>Linkedin</title>
                            <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2 16h-2v-6h2v6zm-1-6.891c-.607 0-1.1-.496-1.1-1.109 0-.612.492-1.109 1.1-1.109s1.1.497 1.1 1.109c0 .613-.493 1.109-1.1 1.109zm8 6.891h-1.998v-2.861c0-1.881-2.002-1.722-2.002 0v2.861h-2v-6h2v1.093c.872-1.616 4-1.736 4 1.548v3.359z" fill="currentColor"></path>
                        </svg>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://x.com/tejusadiga2004">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <title>Twitter</title>
                            <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z" fill="currentColor"></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Full page -->
    <div class="flex-shrink-0 flex-grow-1">

        <!-- Header -->
        <header class="bg-dark text-light shadow-sm pt-3 pb-2">
	<div class="container">
		<h3 id="mastering-apples-iousbhost-framework-modern-usb-communication-on-macos-and-ipados">Mastering Apple's IOUSBHost Framework: Modern USB Communication on macOS and iPadOS</h3>
		<p style="font-size:larger;"><p>A comprehensive guide to Apple's IOUSBHost framework, covering the transition from KEXTs, when to use DriverKit vs IOUSBHost, and complete implementation examples for all USB transfer types in Swift.</p></p>
        <div class="row mx-auto mt-3">
            <div class="col-xs-12 col-sm-12 col-md-6 text-left" style="padding: 0">
                <a href="https://blogs.entropypages.in/author/tejus-adiga-m.html" class="card-link">Tejus Adiga M</a>
                <span class="card-link text-success">
                    <span class="post-date" title="Post date">Sat 28 June 2025</span>
                </span>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-6 text-right" style="padding: 0">
                <a class="badge badge-success" href="https://blogs.entropypages.in/category/macos.html">macos</a>
                    <a class="badge badge-info" href="https://blogs.entropypages.in/tag/macos.html">macos</a>
                    <a class="badge badge-info" href="https://blogs.entropypages.in/tag/iousbhost.html">iousbhost</a>
                    <a class="badge badge-info" href="https://blogs.entropypages.in/tag/usb.html">usb</a>
                    <a class="badge badge-info" href="https://blogs.entropypages.in/tag/driver-development.html">driver development</a>
                    <a class="badge badge-info" href="https://blogs.entropypages.in/tag/driverkit.html">driverkit</a>
            </div>
        </div>
	</div>
        </header>

        <!-- Main -->
        <main class="py-3">
                <div class="container">
                    <!-- Sharing -->

                    <!-- Content -->
    <!-- 2 columns layout -->
    <!-- single column layout -->
        <!-- Sharing -->

        <!-- Share post -->

        <!-- Article -->
        <div>
            <p>The landscape of USB device communication on macOS has undergone significant changes in recent years. With Apple's push towards system security and stability, the traditional Kernel Extension (KEXT) model has been deprecated in favor of modern alternatives like DriverKit and IOUSBHost. This comprehensive guide explores Apple's IOUSBHost framework, explaining when and how to use it for USB device communication, complete with practical Swift implementations.</p>
<h2 id="the-end-of-an-era-why-apple-deprecated-kexts">The End of an Era: Why Apple Deprecated KEXTs</h2>
<h3 id="security-and-stability-concerns">Security and Stability Concerns</h3>
<p>Kernel Extensions (KEXTs) have been a cornerstone of macOS driver development for decades, but they came with significant drawbacks:</p>
<ol>
<li>
<p><strong>Kernel-Level Access</strong>: KEXTs run in kernel space with unrestricted access to system resources, making them potential attack vectors for malicious software.</p>
</li>
<li>
<p><strong>System Instability</strong>: A poorly written or buggy KEXT could crash the entire system, leading to kernel panics and data loss.</p>
</li>
<li>
<p><strong>Debugging Complexity</strong>: Debugging kernel-level code is significantly more complex and requires specialized knowledge.</p>
</li>
<li>
<p><strong>Security Bypass</strong>: KEXTs could potentially bypass system security mechanisms, making them attractive targets for malware.</p>
</li>
</ol>
<h3 id="apples-modern-security-architecture">Apple's Modern Security Architecture</h3>
<p>Starting with macOS Big Sur (11.0), Apple began deprecating KEXTs as part of their broader security initiative:</p>
<ul>
<li><strong>System Integrity Protection (SIP)</strong>: Enhanced protection against system-level modifications</li>
<li><strong>Secure Boot</strong>: Ensuring only trusted code runs during system startup</li>
<li><strong>Gatekeeper</strong>: Preventing unauthorized software from running</li>
<li><strong>Code Signing</strong>: Mandatory signing for all system-level components</li>
</ul>
<h3 id="the-deprecation-timeline">The Deprecation Timeline</h3>
<ul>
<li><strong>macOS Big Sur (11.0)</strong>: KEXT deprecation announced</li>
<li><strong>macOS Monterey (12.0)</strong>: Further restrictions on KEXT loading</li>
<li><strong>macOS Ventura (13.0)</strong>: KEXTs disabled by default for new installations</li>
<li><strong>Future macOS versions</strong>: Complete removal of KEXT support</li>
</ul>
<h2 id="driverkit-vs-iousbhost-choosing-the-right-framework">DriverKit vs IOUSBHost: Choosing the Right Framework</h2>
<h3 id="when-to-use-driverkit">When to Use DriverKit</h3>
<p>DriverKit is Apple's modern replacement for KEXTs, running in user space while providing driver-like capabilities. Use Driver Kit when you're developing drivers for proprietary or specialized hardware, Your device requires deep system integration, Low-latency, high-throughput applications, Devices with complex state management requirements and Building drivers for distribution to end users.</p>
<p>Advantage of driver kit is that is that it runs in user space, hence safer than KEXTs, Apple-approved distribution through the App Store, system-level integration capabilities and performance optimizations for critical applications</p>
<p>Limitation of driver kit is that developers require Apple approval and entitlements to create a driver so that only genuine device manufacturers and authentic usecasses are entertained, Complex development and deployment process, Extensive review process for App Store distribution, Limited to specific use cases approved by Apple</p>
<h3 id="iousbhost-for-the-rest-of-us">IOUSBHost for the rest of us</h3>
<p>IOUSBHost is a user-space framework that provides direct access to USB devices without requiring kernel-level drivers. Use IOUSBHost when your app needs to communicate with USB devices directly, quick development and testing of USB device communication, Working with devices that follow standard USB protocols, integrating existing USB devices into applications and building tools for USB device testing and debugging.</p>
<p>Advantages of IOUSBHost is that no special entitlements required, runs entirely in user space, simpler development process, direct integration with applications and no approval from Apple is required.</p>
<p>However IOUSBHost has few limitations. It is limited to user-space applications, cannot create system-wide device drivers, may have performance limitations for high-throughput scenarios and requires the application to be running for device access</p>
<h2 id="iousbhost-framework-overview">IOUSBHost Framework Overview</h2>
<h3 id="architecture-and-components">Architecture and Components</h3>
<p>IOUSBHost provides a comprehensive framework for USB device communication with several key components:</p>
<ol>
<li><strong>IOUSBHostDevice</strong>: Represents a connected USB device</li>
<li><strong>IOUSBHostInterface</strong>: Represents a USB interface within a device</li>
<li><strong>IOUSBHostPipe</strong>: Represents an endpoint for data transfer</li>
<li><strong>Descriptors</strong>: Various USB descriptors (device, configuration, interface, endpoint)</li>
<li><strong>Transfer Types</strong>: Support for all USB transfer types (control, bulk, interrupt, isochronous)</li>
</ol>
<h2 id="device-discovery-and-enumeration">Device Discovery and Enumeration</h2>
<p>Let us venture into how the devices are discovered from an application point of view and hwo to monitor for device arrival and departure events.</p>
<h3 id="setting-up-device-monitoring">Setting Up Device Monitoring</h3>
<p>The first step in working with USB devices is setting up monitoring for device connections and disconnections:</p>
<div class="highlight"><pre><span></span><code><span class="kd">import</span> <span class="nc">IOKit</span>
<span class="kd">import</span> <span class="nc">IOUSBHost</span>
<span class="kd">import</span> <span class="nc">Foundation</span>

<span class="kd">enum</span> <span class="nc">USBDeviceManagerError</span><span class="p">:</span> <span class="n">Error</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">devicePortFailure</span>
    <span class="k">case</span> <span class="n">deviceOpenFailure</span>
    <span class="k">case</span> <span class="n">deviceCloseFailure</span>
    <span class="k">case</span> <span class="n">deviceDescriptorFailure</span>
    <span class="k">case</span> <span class="n">invalidDeviceDescriptor</span>
    <span class="k">case</span> <span class="n">invalidConfigurationDescriptor</span>
    <span class="k">case</span> <span class="n">configSetFailure</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">USBDeviceManager</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nv">notificationPort</span><span class="p">:</span> <span class="n">IONotificationPortRef</span><span class="p">?</span>
    <span class="kd">var</span> <span class="nv">addedIterator</span><span class="p">:</span> <span class="n">io_iterator_t</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="kd">var</span> <span class="nv">removedIterator</span><span class="p">:</span> <span class="n">io_iterator_t</span> <span class="p">=</span> <span class="mi">0</span>

    <span class="kd">func</span> <span class="nf">setupDevicePNPNotifications</span><span class="p">()</span> <span class="kr">throws</span> 
    <span class="p">{</span>
        <span class="c1">// Create notification port</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">notificationPort</span> <span class="p">=</span> <span class="n">IONotificationPortCreate</span><span class="p">(</span><span class="n">kIOMainPortDefault</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">devicePortFailure</span>
        <span class="p">}</span>

        <span class="c1">// Add notification port to run loop</span>
        <span class="kd">let</span> <span class="nv">runLoopSource</span> <span class="p">=</span> <span class="n">IONotificationPortGetRunLoopSource</span><span class="p">(</span><span class="n">notificationPort</span><span class="p">)</span>
        <span class="n">CFRunLoopAddSource</span><span class="p">(</span><span class="n">CFRunLoopGetCurrent</span><span class="p">(),</span> <span class="n">runLoopSource</span><span class="p">,</span> <span class="n">CFRunLoopMode</span><span class="p">.</span><span class="n">defaultMode</span><span class="p">)</span>

        <span class="c1">// Set up device added notification</span>
        <span class="kd">var</span> <span class="nv">matchingDict</span> <span class="p">=</span> <span class="n">IOServiceMatching</span><span class="p">(</span><span class="n">kIOUSBDeviceClassName</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">addedCallback</span><span class="p">:</span> <span class="n">IOServiceMatchingCallback</span> <span class="p">=</span> <span class="p">{</span> <span class="n">userData</span><span class="p">,</span> <span class="n">iterator</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">manager</span> <span class="p">=</span> <span class="nb">Unmanaged</span><span class="p">&lt;</span><span class="n">USBDeviceManager</span><span class="p">&gt;.</span><span class="n">fromOpaque</span><span class="p">(</span><span class="n">userData</span><span class="p">).</span><span class="n">takeUnretainedValue</span><span class="p">()</span>
            <span class="n">manager</span><span class="p">.</span><span class="n">handleDeviceAdded</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">iterator</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">// Set up device removed notification</span>
        <span class="kd">let</span> <span class="nv">removedCallback</span><span class="p">:</span> <span class="n">IOServiceMatchingCallback</span> <span class="p">=</span> <span class="p">{</span> <span class="n">userData</span><span class="p">,</span> <span class="n">iterator</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">manager</span> <span class="p">=</span> <span class="nb">Unmanaged</span><span class="p">&lt;</span><span class="n">USBDeviceManager</span><span class="p">&gt;.</span><span class="n">fromOpaque</span><span class="p">(</span><span class="n">userData</span><span class="p">!).</span><span class="n">takeUnretainedValue</span><span class="p">()</span>
            <span class="n">manager</span><span class="p">.</span><span class="n">handleDeviceRemoved</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">iterator</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">selfPtr</span> <span class="p">=</span> <span class="nb">Unmanaged</span><span class="p">.</span><span class="n">passUnretained</span><span class="p">(</span><span class="kc">self</span><span class="p">).</span><span class="n">toOpaque</span><span class="p">()</span>
        <span class="kd">var</span> <span class="nv">addedIterator</span><span class="p">:</span> <span class="n">io_iterator_t</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="kd">var</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">IOServiceAddMatchingNotification</span><span class="p">(</span><span class="n">notificationPort</span><span class="p">,</span>
                                                      <span class="n">kIOFirstMatchNotification</span><span class="p">,</span>
                                                      <span class="n">matchingDict</span><span class="p">,</span>
                                                      <span class="n">addedCallback</span><span class="p">,</span>
                                                      <span class="n">selfPtr</span><span class="p">,</span>
                                                      <span class="p">&amp;</span><span class="n">addedIterator</span><span class="p">)</span>

        <span class="k">guard</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">devicePortFailure</span> <span class="p">}</span>

        <span class="kd">var</span> <span class="nv">removedIterator</span><span class="p">:</span> <span class="n">io_iterator_t</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="n">result</span> <span class="p">=</span> <span class="n">IOServiceAddMatchingNotification</span><span class="p">(</span><span class="n">notificationPort</span><span class="p">,</span>
                                                  <span class="n">kIOTerminatedNotification</span><span class="p">,</span>
                                                  <span class="n">IOServiceMatching</span><span class="p">(</span><span class="n">kIOUSBDeviceClassName</span><span class="p">),</span>
                                                  <span class="n">removedCallback</span><span class="p">,</span>
                                                  <span class="n">selfPtr</span><span class="p">,</span>
                                                  <span class="p">&amp;</span><span class="n">removedIterator</span><span class="p">)</span>

        <span class="k">guard</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="k">else</span> <span class="p">{</span> <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">devicePortFailure</span> <span class="p">}</span>

        <span class="c1">// Enumerate all the devices at the begining.</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">handleDeviceAdded</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">addedIterator</span><span class="p">)</span>

        <span class="c1">// Process existing removals</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">handleDeviceRemoved</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">removedIterator</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">logDeviceDescriptor</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="n">io_service_t</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">name</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBProductString</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">vendorID</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBVendorID</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">Int</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">productID</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBProductID</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">Int</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">deviceClass</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBDeviceClass</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">deviceSubclass</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBDeviceSubClass</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">manufacturer</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBVendorString</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">serialNumber</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBSerialNumberString</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">String</span><span class="p">,</span>
            <span class="kd">let</span> <span class="nv">numConfigs</span> <span class="p">=</span> <span class="n">IORegistryEntryCreateCFProperty</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">,</span> <span class="n">kUSBDeviceNumConfigs</span> <span class="k">as</span> <span class="n">CFString</span><span class="p">,</span> <span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="mi">0</span><span class="p">)?.</span><span class="n">takeUnretainedValue</span><span class="p">()</span> <span class="k">as</span><span class="p">?</span> <span class="nb">Int</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">deviceInfo</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            === Device Descriptor ===</span>
<span class="s">            Device Name: String(name)</span>
<span class="s">            Vendor ID: 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">vendorID</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span>
<span class="s">            Product ID: 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">productID</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span>
<span class="s">            Device Class: </span><span class="si">\(</span><span class="n">deviceClass</span><span class="si">)</span>
<span class="s">            Device Subclass: </span><span class="si">\(</span><span class="n">deviceSubclass</span><span class="si">)</span>
<span class="s">            Device Manufacturer: </span><span class="si">\(</span><span class="n">manufacturer</span><span class="si">)</span>
<span class="s">            Number of Configurations: </span><span class="si">\(</span><span class="n">numConfigs</span><span class="si">)</span>
<span class="s">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">logInfo</span><span class="p">(</span><span class="n">deviceInfo</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">createDevice</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="n">io_service_t</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span> <span class="p">=</span> <span class="n">Logger</span><span class="p">())</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">IOUSBHostDevice</span>
    <span class="p">{</span>
        <span class="c1">// Create the IOUSBHostDevice object. The option deviceCapture is used to claim the exclusive </span>
        <span class="c1">// ownership on the device so that macOS does nto get to know about the device.</span>
        <span class="kd">var</span> <span class="nv">error</span><span class="p">:</span> <span class="bp">NSError</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span>
        <span class="kd">let</span> <span class="nv">device</span> <span class="p">=</span> <span class="n">IOUSBHostDevice</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> 
                                     <span class="n">options</span><span class="p">:</span> <span class="p">.</span><span class="n">deviceCapture</span><span class="p">,</span> 
                                     <span class="n">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> 
                                     <span class="n">error</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span> 
                                        <span class="n">logger</span><span class="p">.</span><span class="n">logInfo</span><span class="p">(</span><span class="s">&quot;State Changed $1&quot;</span><span class="p">)</span>
                                     <span class="p">}</span>

        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">error</span> <span class="k">else</span> <span class="p">{</span> 
            <span class="n">logger</span><span class="p">.</span><span class="n">logError</span><span class="p">(</span><span class="s">&quot;Failed to open the device with exclusive access with error </span><span class="si">\(</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">throw</span> <span class="n">error</span> 
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">device</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">handleDeviceAdded</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">io_iterator_t</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">service</span><span class="p">:</span> <span class="n">io_service_t</span> <span class="p">=</span> <span class="n">IOIteratorNext</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">service</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>

            <span class="kc">self</span><span class="p">.</span><span class="n">logDeviceDescriptor</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="n">service</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">())</span>

            <span class="c1">// Create IOUSBHostDevice from service</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">device</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">createDevice</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="n">service</span><span class="p">)</span> <span class="p">{</span>
                <span class="kc">self</span><span class="p">.</span><span class="n">processNewDevice</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="n">IOObjectRelease</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
            <span class="n">service</span> <span class="p">=</span> <span class="n">IOIteratorNext</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">handleDeviceRemoved</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">io_iterator_t</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">service</span><span class="p">:</span> <span class="n">io_service_t</span> <span class="p">=</span> <span class="n">IOIteratorNext</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">service</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="n">IOObjectRelease</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
            <span class="n">service</span> <span class="p">=</span> <span class="n">IOIteratorNext</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">processNewDevice</span><span class="p">(</span><span class="kc">_</span> <span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="c1">// Device added. Enumerate the device descriptors to get information about the new device.</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">enumerateConfigurationDescriptors</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="p">}</span> 

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">processDeviceRemovedEvent</span><span class="p">(</span><span class="kc">_</span> <span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="c1">// One of the device is removed. So re eunmerate the device descriptors.</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">enumerateConfigurationDescriptors</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="opening-and-accessing-usb-devices">Opening and Accessing USB Devices</h3>
<p>Once a device is discovered, you need to open it for communication:</p>
<div class="highlight"><pre><span></span><code><span class="kd">extension</span> <span class="nc">USBDeviceManager</span> 
<span class="p">{</span>
    <span class="kd">func</span> <span class="nf">openDevice</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> <span class="kr">throws</span> 
    <span class="p">{</span>
        <span class="c1">// Open the device for exclusive access</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">open</span><span class="p">()</span>  <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">deviceOpenFailure</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">closeDevice</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">deviceCloseFailure</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="descriptor-enumeration-and-analysis">Descriptor Enumeration and Analysis</h2>
<h3 id="device-descriptor">Device Descriptor</h3>
<p>The device descriptor contains basic information about the USB device:</p>
<div class="highlight"><pre><span></span><code><span class="kd">extension</span> <span class="nc">USBDeviceManager</span> 
<span class="p">{</span>
    <span class="kd">func</span> <span class="nf">logDeviceDescriptor</span><span class="p">(</span><span class="n">deviceDesc</span><span class="p">:</span> <span class="n">IOUSBDeviceDescriptor</span><span class="p">:</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">configurationInfo</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            === Device Descriptor ===</span>
<span class="s">            bLength: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bLength</span><span class="si">)</span>
<span class="s">            bDescriptorType: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bDescriptorType</span><span class="si">)</span>
<span class="s">            bcdUSB: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bcdUSB</span><span class="si">)</span>
<span class="s">            bDescriptorType: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bDescriptorType</span><span class="si">)</span>
<span class="s">            idVendor: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">idVendor</span><span class="si">)</span>
<span class="s">            idProduct: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">idProduct</span><span class="si">)</span>
<span class="s">            bDeviceSubClass: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bDeviceSubClass</span><span class="si">)</span>
<span class="s">            bDeviceProtocol: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bDeviceProtocol</span><span class="si">)</span>
<span class="s">            bMaxPacketSize0: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bMaxPacketSize0</span><span class="si">)</span>
<span class="s">            bcdDevice: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bcdDevice</span><span class="si">)</span>
<span class="s">            iManufacturer: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">iManufacturer</span><span class="si">)</span>
<span class="s">            iProduct: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">iProduct</span><span class="si">)</span>
<span class="s">            iSerialNumber: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">iSerialNumber</span><span class="si">)</span>
<span class="s">            bNumConfigurations: </span><span class="si">\(</span><span class="n">deviceDesc</span><span class="p">.</span><span class="n">bNumConfigurations</span><span class="si">)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">logInfo</span><span class="p">(</span><span class="n">configurationInfo</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enumerateDeviceDescriptor</span><span class="p">(</span><span class="k">for</span> <span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">IOUSBDeviceDescriptor</span>
    <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">deviceDesc</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">deviceDescriptor</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">invalidDeviceDescriptor</span>
        <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">logDeviceDescriptor</span><span class="p">(</span><span class="n">deviceDesc</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="configuration-descriptor">Configuration Descriptor</h3>
<p>Configuration descriptors describe how the device can be configured:</p>
<div class="highlight"><pre><span></span><code><span class="kd">extension</span> <span class="nc">USBDeviceManager</span> 
<span class="p">{</span>
    <span class="kd">func</span> <span class="nf">logConfigDescriptor</span><span class="p">(</span><span class="n">configDesc</span><span class="p">:</span><span class="n">IOUSBConfigurationDescriptor</span><span class="p">,</span>  <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">configurationInfo</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            === Configuration Descriptor ===</span>
<span class="s">            bLength: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">bLength</span><span class="si">)</span>
<span class="s">            bDescriptorType: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">bDescriptorType</span><span class="si">)</span>
<span class="s">            wTotalLength: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">wTotalLength</span><span class="si">)</span>
<span class="s">            bNumInterfaces: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">bNumInterfaces</span><span class="si">)</span>
<span class="s">            bConfigurationValue: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">bConfigurationValue</span><span class="si">)</span>
<span class="s">            iConfiguration: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">iConfiguration</span><span class="si">)</span>
<span class="s">            bmAttributes: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">bmAttributes</span><span class="si">)</span>
<span class="s">            MaxPower: </span><span class="si">\(</span><span class="n">configDesc</span><span class="p">.</span><span class="n">MaxPower</span><span class="si">)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">logInfo</span><span class="p">(</span><span class="n">configurationInfo</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enumerateConfigurations</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">IOUSBConfigurationDescriptor</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">deviceDescriptor</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">deviceDescriptor</span> <span class="k">else</span> <span class="p">{</span> 
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">invalidDeviceDescriptor</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">[</span><span class="mf">0.</span><span class="p">.&lt;</span><span class="n">deviceDescriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span><span class="p">].</span><span class="bp">map</span> <span class="p">{</span>
            <span class="n">enumerateConfiguration</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">configurationIndex</span><span class="p">:</span> <span class="nv">$0</span><span class="err">$</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enumerateConfiguration</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">,</span>
                                <span class="n">configurationIndex</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">IOUSBConfigurationDescriptor</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="c1">// Get configuration descriptor</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">configDescriptor</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">configurationDescriptor</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">configurationIndex</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">invalidConfigurationDescriptor</span>
        <span class="p">}</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">logConfigDescriptor</span><span class="p">(</span><span class="n">configDescriptor</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Set the configuration so that the device expose the Interfaces for this configuration. </span>
    <span class="c1">// The device may take some time to complete exposing the interfaces.  </span>
    <span class="kd">func</span> <span class="nf">setConfiguration</span><span class="p">(</span><span class="n">configDesc</span><span class="p">:</span> <span class="n">IOUSBConfigurationDescriptor</span><span class="p">)</span> <span class="kr">throws</span> 
    <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">setConfigResult</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">setConfiguration</span><span class="p">(</span><span class="n">configDescriptor</span><span class="p">.</span><span class="n">bConfigurationValue</span><span class="p">),</span>
              <span class="n">setConfigResult</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="n">USBDeviceManagerError</span><span class="p">.</span><span class="n">configSetFailure</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">logStringDescriptors</span><span class="p">(</span><span class="n">stringDesc</span><span class="p">:</span><span class="n">IOUSBStringDescriptor</span><span class="p">,</span>  <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">stringDescInfo</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            === String Descriptor ===</span>
<span class="s">            bLength: </span><span class="si">\(</span><span class="n">stringDesc</span><span class="p">.</span><span class="n">bLength</span><span class="si">)</span>
<span class="s">            bDescriptorType: </span><span class="si">\(</span><span class="n">stringDesc</span><span class="p">.</span><span class="n">bDescriptorType</span><span class="si">)</span>
<span class="s">            bString: </span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">stringDesc</span><span class="p">.</span><span class="n">bString</span><span class="si">))</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">logInfo</span><span class="p">(</span><span class="n">stringDescInfo</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enumerateStringDescriptors</span><span class="p">(</span><span class="n">configDesc</span><span class="p">:</span> <span class="n">IOUSBConfigurationDescriptor</span><span class="p">)</span>  <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">IOUSBStringDescriptor</span><span class="p">]</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">stringDescriptors</span><span class="p">:</span> <span class="p">[</span><span class="n">IOUSBStringDescriptor</span><span class="p">]()</span>
        <span class="kd">var</span> <span class="nv">currentDesc</span><span class="p">:</span> <span class="n">IOUSBDescriptorHeader</span>
        <span class="k">while</span> <span class="n">currentDesc</span> <span class="p">=</span> <span class="n">IOUSBGetNextDescriptorWithType</span><span class="p">(</span><span class="n">configurationDescriptor</span><span class="p">:</span> <span class="n">configDesc</span><span class="p">,</span> <span class="n">currentDescriptor</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">currentDesc</span><span class="p">,</span> <span class="n">type</span><span class="p">:</span> <span class="n">kIOUSBDescriptorTypeString</span><span class="p">),</span> <span class="n">currentDesc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">stringDesc</span> <span class="p">=</span> <span class="n">currentDesc</span> <span class="k">as</span> <span class="n">IOUSBStringDescriptor</span>
            <span class="n">configDescriptors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">stringDesc</span><span class="p">)</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">logStringDescriptors</span><span class="p">(</span><span class="n">stringDesc</span><span class="p">:</span> <span class="n">stringDesc</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="interface-descriptor">Interface Descriptor</h3>
<p>Interface descriptors define functional units within a configuration:</p>
<div class="highlight"><pre><span></span><code><span class="kd">extension</span> <span class="nc">USBDeviceManager</span> 
<span class="p">{</span>
    <span class="kd">func</span> <span class="nf">logInterfaceDescriptor</span><span class="p">(</span><span class="n">interfaceDesc</span><span class="p">:</span><span class="n">IOUSBInterfaceDescriptor</span><span class="p">,</span>  <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">configurationInfo</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">            === Interface Descriptor ===</span>
<span class="s">            Interface Number: </span><span class="si">\(</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="si">)</span>
<span class="s">            Alternate Setting: </span><span class="si">\(</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="si">)</span>
<span class="s">            Interface Class: </span><span class="si">\(</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bInterfaceClass</span><span class="si">)</span>
<span class="s">            Interface Subclass: </span><span class="si">\(</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bInterfaceSubClass</span><span class="si">)</span>
<span class="s">            Interface Protocol: </span><span class="si">\(</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bInterfaceProtocol</span><span class="si">)</span>
<span class="s">            Number of Endpoints: </span><span class="si">\(</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="si">)</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">logInfo</span><span class="p">(</span><span class="n">configurationInfo</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enumerateInterfaces</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">,</span> 
                             <span class="n">configuration</span><span class="p">:</span> <span class="n">IOUSBConfigurationDescriptor</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="mf">0.</span><span class="p">.&lt;</span><span class="n">configuration</span><span class="p">.</span><span class="n">bNumInterfaces</span><span class="p">].</span><span class="bp">map</span> <span class="p">{</span>
            <span class="n">enumerateInterface</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">interfaceIndex</span><span class="p">:</span> <span class="n">interfaceIndex</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
            <span class="kc">self</span><span class="p">.</span><span class="n">logInterfaceDescriptor</span><span class="p">(</span><span class="n">interfaceDesc</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">enumerateInterface</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">,</span> <span class="n">interfaceIndex</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Find the interface</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interface</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">interface</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">interfaceIndex</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to get interface </span><span class="si">\(</span><span class="n">interfaceIndex</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">// Open the interface</span>
        <span class="kd">let</span> <span class="nv">openResult</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">open</span><span class="p">()</span>
        <span class="k">guard</span> <span class="n">openResult</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to open interface </span><span class="si">\(</span><span class="n">interfaceIndex</span><span class="si">)</span><span class="s">: </span><span class="si">\(</span><span class="n">openResult</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">defer</span> <span class="p">{</span> <span class="n">interface</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="p">}</span>

        <span class="c1">// Get interface descriptor</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interfaceDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">interfaceDescriptor</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to get interface descriptor for interface </span><span class="si">\(</span><span class="n">interfaceIndex</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">logInterfaceDescriptor</span><span class="p">(</span><span class="n">interfaceDescriptor</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span><span class="p">())</span>

        <span class="c1">// Get interface string descriptor</span>
        <span class="k">if</span> <span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">interfaceString</span> <span class="p">=</span> <span class="n">getStringDescriptor</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">iInterface</span><span class="p">)</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interface: </span><span class="si">\(</span><span class="n">interfaceString</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Print interface class information</span>
        <span class="n">printInterfaceClassInfo</span><span class="p">(</span><span class="n">interfaceDescriptor</span><span class="p">)</span>

        <span class="c1">// Enumerate endpoints</span>
        <span class="n">enumerateEndpoints</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="endpoint-descriptor">Endpoint Descriptor</h3>
<p>Endpoint descriptors define communication endpoints:</p>
<div class="highlight"><pre><span></span><code><span class="kd">extension</span> <span class="nc">USBDeviceManager</span>
<span class="p">{</span>
    <span class="kd">func</span> <span class="nf">enumerateEndpoints</span><span class="p">(</span><span class="kc">_</span> <span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interfaceDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">interfaceDescriptor</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">for</span> <span class="n">endpointIndex</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bNumEndpoints</span> 
        <span class="p">{</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">endpointDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">endpointDescriptor</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">endpointIndex</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">--- Endpoint </span><span class="si">\(</span><span class="n">endpointIndex</span><span class="si">)</span><span class="s"> ---&quot;</span><span class="p">)</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Endpoint Address: 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span><span class="s">&quot;</span><span class="p">)</span>

                <span class="kd">let</span> <span class="nv">direction</span> <span class="p">=</span> <span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">?</span> <span class="s">&quot;IN&quot;</span> <span class="p">:</span> <span class="s">&quot;OUT&quot;</span>
                <span class="kd">let</span> <span class="nv">endpointNumber</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0F</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Direction: </span><span class="si">\(</span><span class="n">direction</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Endpoint Number: </span><span class="si">\(</span><span class="n">endpointNumber</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>

                <span class="c1">// Transfer type</span>
                <span class="kd">let</span> <span class="nv">transferType</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span>
                <span class="k">switch</span> <span class="n">transferType</span> <span class="p">{</span>
                <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Transfer Type: Control&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Transfer Type: Isochronous&quot;</span><span class="p">)</span>

                    <span class="c1">// Isochronous attributes</span>
                    <span class="kd">let</span> <span class="nv">syncType</span> <span class="p">=</span> <span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span>
                    <span class="kd">let</span> <span class="nv">usageType</span> <span class="p">=</span> <span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span>

                    <span class="k">switch</span> <span class="n">syncType</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Synchronization: No Sync&quot;</span><span class="p">)</span>
                    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Synchronization: Asynchronous&quot;</span><span class="p">)</span>
                    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Synchronization: Adaptive&quot;</span><span class="p">)</span>
                    <span class="k">case</span> <span class="mi">3</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Synchronization: Synchronous&quot;</span><span class="p">)</span>
                    <span class="k">default</span><span class="p">:</span> <span class="k">break</span>
                    <span class="p">}</span>

                    <span class="k">switch</span> <span class="n">usageType</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Usage: Data&quot;</span><span class="p">)</span>
                    <span class="k">case</span> <span class="mi">1</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Usage: Feedback&quot;</span><span class="p">)</span>
                    <span class="k">case</span> <span class="mi">2</span><span class="p">:</span> <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Usage: Implicit Feedback&quot;</span><span class="p">)</span>
                    <span class="k">default</span><span class="p">:</span> <span class="k">break</span>
                    <span class="p">}</span>

                <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Transfer Type: Bulk&quot;</span><span class="p">)</span>
                <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Transfer Type: Interrupt&quot;</span><span class="p">)</span>
                <span class="k">default</span><span class="p">:</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Transfer Type: Unknown&quot;</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Max Packet Size: </span><span class="si">\(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interval: </span><span class="si">\(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bInterval</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="usb-transfer-types-implementation">USB Transfer Types Implementation</h2>
<h3 id="control-transfers">Control Transfers</h3>
<p>Control transfers are used for device configuration and control operations:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">USBControlTransfer</span> 
<span class="p">{</span>
    <span class="kd">let</span> <span class="nv">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">device</span> <span class="p">=</span> <span class="n">device</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performControlTransfer</span><span class="p">(</span><span class="n">requestType</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">,</span>
                                <span class="n">request</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">,</span>
                                <span class="n">value</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">,</span>
                                <span class="n">index</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">,</span>
                                <span class="n">data</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span>
                                <span class="n">length</span><span class="p">:</span> <span class="nb">UInt16</span> <span class="p">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">deviceRequest</span> <span class="p">=</span> <span class="n">IOUSBDeviceRequest</span><span class="p">()</span>
        <span class="n">deviceRequest</span><span class="p">.</span><span class="n">bmRequestType</span> <span class="p">=</span> <span class="n">requestType</span>
        <span class="n">deviceRequest</span><span class="p">.</span><span class="n">bRequest</span> <span class="p">=</span> <span class="n">request</span>
        <span class="n">deviceRequest</span><span class="p">.</span><span class="n">wValue</span> <span class="p">=</span> <span class="n">value</span>
        <span class="n">deviceRequest</span><span class="p">.</span><span class="n">wIndex</span> <span class="p">=</span> <span class="n">index</span>
        <span class="n">deviceRequest</span><span class="p">.</span><span class="n">wLength</span> <span class="p">=</span> <span class="n">length</span>
        <span class="n">deviceRequest</span><span class="p">.</span><span class="n">pData</span> <span class="p">=</span> <span class="n">data</span>

        <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">deviceRequest</span><span class="p">(&amp;</span><span class="n">deviceRequest</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Control transfer successful. Bytes transferred: </span><span class="si">\(</span><span class="n">deviceRequest</span><span class="p">.</span><span class="n">wLenDone</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Control transfer failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="p">}</span>

    <span class="c1">// Get device status</span>
    <span class="kd">func</span> <span class="nf">getDeviceStatus</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">UInt16</span><span class="p">?</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">status</span><span class="p">:</span> <span class="nb">UInt16</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">performControlTransfer</span><span class="p">(</span>
            <span class="n">requestType</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequestDirection_In</span> <span class="o">|</span> <span class="n">kIOUSBRequestType_Standard</span> <span class="o">|</span> <span class="n">kIOUSBRequestRecipient_Device</span><span class="p">),</span>
            <span class="n">request</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequest_GetStatus</span><span class="p">),</span>
            <span class="n">value</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">status</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">?</span> <span class="n">status</span> <span class="p">:</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="c1">// Clear endpoint halt</span>
    <span class="kd">func</span> <span class="nf">clearEndpointHalt</span><span class="p">(</span><span class="n">endpointAddress</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">performControlTransfer</span><span class="p">(</span>
            <span class="n">requestType</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequestDirection_Out</span> <span class="o">|</span> <span class="n">kIOUSBRequestType_Standard</span> <span class="o">|</span> <span class="n">kIOUSBRequestRecipient_Endpoint</span><span class="p">),</span>
            <span class="n">request</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequest_ClearFeature</span><span class="p">),</span>
            <span class="n">value</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">(</span><span class="n">kIOUSBFeature_EndpointHalt</span><span class="p">),</span>
            <span class="n">index</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">(</span><span class="n">endpointAddress</span><span class="p">),</span>
            <span class="n">data</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Set interface alternate setting</span>
    <span class="kd">func</span> <span class="nf">setInterfaceAltSetting</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">,</span> <span class="n">altSetting</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">performControlTransfer</span><span class="p">(</span>
            <span class="n">requestType</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequestDirection_Out</span> <span class="o">|</span> <span class="n">kIOUSBRequestType_Standard</span> <span class="o">|</span> <span class="n">kIOUSBRequestRecipient_Interface</span><span class="p">),</span>
            <span class="n">request</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequest_SetInterface</span><span class="p">),</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">altSetting</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Vendor-specific control transfer</span>
    <span class="kd">func</span> <span class="nf">vendorControlTransfer</span><span class="p">(</span><span class="n">direction</span><span class="p">:</span> <span class="nb">Bool</span><span class="p">,</span> <span class="c1">// true for IN, false for OUT</span>
                               <span class="n">request</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">,</span>
                               <span class="n">value</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">,</span>
                               <span class="n">index</span><span class="p">:</span> <span class="nb">UInt16</span><span class="p">,</span>
                               <span class="n">data</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">,</span>
                               <span class="n">length</span><span class="p">:</span> <span class="nb">UInt16</span> <span class="p">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span> 
    <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">requestType</span><span class="p">:</span> <span class="nb">UInt8</span> <span class="p">=</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequestType_Vendor</span> <span class="o">|</span> <span class="n">kIOUSBRequestRecipient_Device</span><span class="p">)</span> <span class="o">|</span>
                                <span class="p">(</span><span class="n">direction</span> <span class="p">?</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequestDirection_In</span><span class="p">)</span> <span class="p">:</span> <span class="nb">UInt8</span><span class="p">(</span><span class="n">kIOUSBRequestDirection_Out</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">performControlTransfer</span><span class="p">(</span>
            <span class="n">requestType</span><span class="p">:</span> <span class="n">requestType</span><span class="p">,</span>
            <span class="n">request</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
            <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="n">length</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="bulk-transfers">Bulk Transfers</h3>
<p>Bulk transfers are used for large data transfers without timing guarantees:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">USBBulkTransfer</span> 
<span class="p">{</span>
    <span class="kd">let</span> <span class="nv">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span>
    <span class="kd">let</span> <span class="nv">pipe</span><span class="p">:</span> <span class="n">IOUSBHostPipe</span>

    <span class="kd">init</span><span class="p">?(</span><span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">interface</span> <span class="p">=</span> <span class="n">interface</span>

        <span class="c1">// Find the pipe for the given endpoint</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">pipe</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">endpointAddress</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to find pipe for endpoint 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">endpointAddress</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">pipe</span> <span class="p">=</span> <span class="n">pipe</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performBulkWrite</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span> 
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">withUnsafeBytes</span> <span class="p">{</span> <span class="n">bytes</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">bindMemory</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="nb">Void</span><span class="p">.</span><span class="kc">self</span><span class="p">).</span><span class="n">baseAddress</span><span class="p">!,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="p">),</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Bulk write successful. Sent </span><span class="si">\(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> bytes&quot;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Bulk write failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performBulkRead</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">,</span> 
                         <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span> 
                         <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">bytesRead</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span> <span class="n">bytesTransferred</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">bytesRead</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Bulk read successful. Received </span><span class="si">\(</span><span class="n">bytesRead</span><span class="si">)</span><span class="s"> bytes&quot;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Bulk read failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performBulkReadToData</span><span class="p">(</span><span class="n">maxLength</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span> 
                               <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">,</span> <span class="n">Data</span><span class="p">?)</span>
     <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">buffer</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">byteCount</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">maxLength</span><span class="p">),</span> <span class="n">alignment</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">defer</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span> <span class="p">}</span>

        <span class="kd">let</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">)</span> <span class="p">=</span> <span class="n">performBulkRead</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">maxLength</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="o">&amp;&amp;</span> <span class="n">bytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">buffer</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">bytesRead</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Asynchronous bulk transfer</span>
    <span class="kd">func</span> <span class="nf">performAsyncBulkWrite</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span>
                               <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">,</span>
                               <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">data</span><span class="p">.</span><span class="n">withUnsafeBytes</span> <span class="p">{</span> <span class="n">bytes</span> <span class="k">in</span>
            <span class="c1">// Create completion handler</span>
            <span class="kd">let</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="n">IOUSBHostCompletionHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="kc">_</span> <span class="k">in</span>
                <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                    <span class="n">completion</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// Perform async transfer</span>
            <span class="n">pipe</span><span class="p">.</span><span class="n">sendAsync</span><span class="p">(</span>
                <span class="n">bytes</span><span class="p">.</span><span class="n">bindMemory</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="nb">Void</span><span class="p">.</span><span class="kc">self</span><span class="p">).</span><span class="n">baseAddress</span><span class="p">!,</span>
                <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="p">),</span>
                <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
                <span class="n">completion</span><span class="p">:</span> <span class="n">completionHandler</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performAsyncBulkRead</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">,</span>
                              <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span>
                              <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">5000</span><span class="p">,</span>
                              <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// Create completion handler</span>
        <span class="kd">let</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="n">IOUSBHostCompletionHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="n">bytesTransferred</span> <span class="k">in</span>
            <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                <span class="n">completion</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bytesTransferred</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Perform async transfer</span>
        <span class="n">pipe</span><span class="p">.</span><span class="n">receiveAsync</span><span class="p">(</span>
            <span class="n">buffer</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="n">completion</span><span class="p">:</span> <span class="n">completionHandler</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="interrupt-transfers">Interrupt Transfers</h3>
<p>Interrupt transfers are used for periodic data transfers with guaranteed bandwidth:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">USBInterruptTransfer</span> 
<span class="p">{</span>
    <span class="kd">let</span> <span class="nv">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span>
    <span class="kd">let</span> <span class="nv">pipe</span><span class="p">:</span> <span class="n">IOUSBHostPipe</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">isReading</span> <span class="p">=</span> <span class="kc">false</span>

    <span class="kd">init</span><span class="p">?(</span><span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">interface</span> <span class="p">=</span> <span class="n">interface</span>

        <span class="c1">// Find the pipe for the given endpoint</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">pipe</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">endpointAddress</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to find interrupt pipe for endpoint 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">endpointAddress</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">pipe</span> <span class="p">=</span> <span class="n">pipe</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performInterruptWrite</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span> 
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">withUnsafeBytes</span> <span class="p">{</span> <span class="n">bytes</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">bindMemory</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="nb">Void</span><span class="p">.</span><span class="kc">self</span><span class="p">).</span><span class="n">baseAddress</span><span class="p">!,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="p">),</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interrupt write successful. Sent </span><span class="si">\(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> bytes&quot;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interrupt write failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performInterruptRead</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">,</span> 
                              <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span> 
                              <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">bytesRead</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">receive</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span> <span class="n">bytesTransferred</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">bytesRead</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interrupt read successful. Received </span><span class="si">\(</span><span class="n">bytesRead</span><span class="si">)</span><span class="s"> bytes&quot;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">kIOReturnTimeout</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interrupt read failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Continuous interrupt reading (for devices that send periodic data)</span>
    <span class="kd">func</span> <span class="nf">startContinuousReading</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">64</span><span class="p">,</span>
                                <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">1000</span><span class="p">,</span>
                                <span class="n">dataHandler</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">,</span>
                                <span class="n">errorHandler</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="k">guard</span> <span class="o">!</span><span class="n">isReading</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Already reading from interrupt endpoint&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">isReading</span> <span class="p">=</span> <span class="kc">true</span>

        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">(</span><span class="n">qos</span><span class="p">:</span> <span class="p">.</span><span class="n">userInitiated</span><span class="p">).</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">self</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="kd">let</span> <span class="nv">buffer</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">byteCount</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">),</span> <span class="n">alignment</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">defer</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span> <span class="p">}</span>

            <span class="k">while</span> <span class="kc">self</span><span class="p">.</span><span class="n">isReading</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">)</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">performInterruptRead</span><span class="p">(</span>
                    <span class="n">buffer</span><span class="p">:</span> <span class="n">buffer</span><span class="p">,</span>
                    <span class="n">length</span><span class="p">:</span> <span class="n">bufferSize</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="o">&amp;&amp;</span> <span class="n">bytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">buffer</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">bytesRead</span><span class="p">))</span>
                    <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                        <span class="n">dataHandler</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">kIOReturnTimeout</span> <span class="p">{</span>
                    <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                        <span class="n">errorHandler</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="k">break</span>
                <span class="p">}</span>

                <span class="c1">// Small delay to prevent excessive CPU usage</span>
                <span class="n">usleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="c1">// 1ms</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">stopContinuousReading</span><span class="p">()</span> 
    <span class="p">{</span>
        <span class="n">isReading</span> <span class="p">=</span> <span class="kc">false</span>

        <span class="c1">// Abort any pending transfers</span>
        <span class="n">pipe</span><span class="p">.</span><span class="n">abort</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// Asynchronous interrupt transfer</span>
    <span class="kd">func</span> <span class="nf">performAsyncInterruptRead</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">,</span>
                                   <span class="n">length</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span>
                                   <span class="n">timeout</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">1000</span><span class="p">,</span>
                                   <span class="n">completion</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">,</span> <span class="nb">UInt32</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span><span class="err">\</span>
    <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">completionHandler</span><span class="p">:</span> <span class="n">IOUSBHostCompletionHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="n">bytesTransferred</span> <span class="k">in</span>
            <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                <span class="n">completion</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">bytesTransferred</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">pipe</span><span class="p">.</span><span class="n">receiveAsync</span><span class="p">(</span>
            <span class="n">buffer</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="n">length</span><span class="p">,</span>
            <span class="n">timeout</span><span class="p">:</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="n">completion</span><span class="p">:</span> <span class="n">completionHandler</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="isochronous-transfers">Isochronous Transfers</h3>
<p>Isochronous transfers provide guaranteed bandwidth and are used for time-sensitive data like audio/video:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">USBIsochronousTransfer</span> 
<span class="p">{</span>
    <span class="kd">let</span> <span class="nv">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span>
    <span class="kd">let</span> <span class="nv">pipe</span><span class="p">:</span> <span class="n">IOUSBHostPipe</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">isStreaming</span> <span class="p">=</span> <span class="kc">false</span>

    <span class="kd">init</span><span class="p">?(</span><span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">interface</span> <span class="p">=</span> <span class="n">interface</span>

        <span class="c1">// Find the pipe for the given endpoint</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">pipe</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">address</span><span class="p">:</span> <span class="n">endpointAddress</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to find isochronous pipe for endpoint 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">endpointAddress</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>

        <span class="kc">self</span><span class="p">.</span><span class="n">pipe</span> <span class="p">=</span> <span class="n">pipe</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performIsochronousWrite</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">,</span>
                                 <span class="n">frameCount</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span>
                                 <span class="n">frameSize</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">IOReturn</span>
    <span class="p">{</span>
        <span class="c1">// Create frame list</span>
        <span class="kd">let</span> <span class="nv">frameList</span> <span class="p">=</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="n">IOUSBHostIsochronousFrame</span><span class="p">&gt;.</span><span class="n">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span><span class="p">))</span>
        <span class="k">defer</span> <span class="p">{</span> <span class="n">frameList</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span> <span class="p">}</span>

        <span class="c1">// Initialize frames</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frStatus</span> <span class="p">=</span> <span class="n">kIOReturnInvalid</span>
            <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frReqCount</span> <span class="p">=</span> <span class="n">frameSize</span>
            <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frActCount</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">withUnsafeBytes</span> <span class="p">{</span> <span class="n">bytes</span> <span class="k">in</span>
            <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">sendIsochronous</span><span class="p">(</span>
                <span class="n">bytes</span><span class="p">.</span><span class="n">bindMemory</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="nb">Void</span><span class="p">.</span><span class="kc">self</span><span class="p">).</span><span class="n">baseAddress</span><span class="p">!,</span>
                <span class="n">frameCount</span><span class="p">:</span> <span class="n">frameCount</span><span class="p">,</span>
                <span class="n">frameList</span><span class="p">:</span> <span class="n">frameList</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Isochronous write initiated for </span><span class="si">\(</span><span class="n">frameCount</span><span class="si">)</span><span class="s"> frames&quot;</span><span class="p">)</span>

                <span class="c1">// Check frame results</span>
                <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frStatus</span> <span class="o">!=</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Frame </span><span class="si">\(</span><span class="n">i</span><span class="si">)</span><span class="s"> failed: </span><span class="si">\(</span><span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frStatus</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Isochronous write failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">performIsochronousRead</span><span class="p">(</span><span class="n">buffer</span><span class="p">:</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">,</span>
                                <span class="n">frameCount</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">,</span>
                                <span class="n">frameSize</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">,</span> <span class="p">[</span><span class="n">IOUSBHostIsochronousFrame</span><span class="p">])</span> 
    <span class="p">{</span>
        <span class="c1">// Create frame list</span>
        <span class="kd">let</span> <span class="nv">frameList</span> <span class="p">=</span> <span class="nb">UnsafeMutablePointer</span><span class="p">&lt;</span><span class="n">IOUSBHostIsochronousFrame</span><span class="p">&gt;.</span><span class="n">allocate</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span> <span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span><span class="p">))</span>
        <span class="k">defer</span> <span class="p">{</span> <span class="n">frameList</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span> <span class="p">}</span>

        <span class="c1">// Initialize frames</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frStatus</span> <span class="p">=</span> <span class="n">kIOReturnInvalid</span>
            <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frReqCount</span> <span class="p">=</span> <span class="n">frameSize</span>
            <span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">frActCount</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">receiveIsochronous</span><span class="p">(</span>
            <span class="n">buffer</span><span class="p">,</span>
            <span class="n">frameCount</span><span class="p">:</span> <span class="n">frameCount</span><span class="p">,</span>
            <span class="n">frameList</span><span class="p">:</span> <span class="n">frameList</span>
        <span class="p">)</span>

        <span class="c1">// Copy frame results</span>
        <span class="kd">var</span> <span class="nv">frames</span><span class="p">:</span> <span class="p">[</span><span class="n">IOUSBHostIsochronousFrame</span><span class="p">]</span> <span class="p">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">frames</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">frameList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Isochronous read completed for </span><span class="si">\(</span><span class="n">frameCount</span><span class="si">)</span><span class="s"> frames&quot;</span><span class="p">)</span>

            <span class="c1">// Check frame results</span>
            <span class="kd">var</span> <span class="nv">successfulFrames</span> <span class="p">=</span> <span class="mi">0</span>
            <span class="kd">var</span> <span class="nv">totalBytesReceived</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="k">in</span> <span class="n">frames</span><span class="p">.</span><span class="n">enumerated</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">frame</span><span class="p">.</span><span class="n">frStatus</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                    <span class="n">successfulFrames</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">totalBytesReceived</span> <span class="o">+=</span> <span class="n">frame</span><span class="p">.</span><span class="n">frActCount</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Frame </span><span class="si">\(</span><span class="n">i</span><span class="si">)</span><span class="s"> failed: </span><span class="si">\(</span><span class="n">frame</span><span class="p">.</span><span class="n">frStatus</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Successful frames: </span><span class="si">\(</span><span class="n">successfulFrames</span><span class="si">)</span><span class="s">/</span><span class="si">\(</span><span class="n">frameCount</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Total bytes received: </span><span class="si">\(</span><span class="n">totalBytesReceived</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Isochronous read failed: </span><span class="si">\(</span><span class="n">result</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Continuous isochronous streaming</span>
    <span class="kd">func</span> <span class="nf">startIsochronousStreaming</span><span class="p">(</span><span class="n">frameCount</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">8</span><span class="p">,</span>
                                   <span class="n">frameSize</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">1024</span><span class="p">,</span>
                                   <span class="n">dataHandler</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">Data</span><span class="p">,</span> <span class="p">[</span><span class="n">IOUSBHostIsochronousFrame</span><span class="p">])</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">,</span>
                                   <span class="n">errorHandler</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">(</span><span class="n">IOReturn</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">guard</span> <span class="o">!</span><span class="n">isStreaming</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Already streaming from isochronous endpoint&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="n">isStreaming</span> <span class="p">=</span> <span class="kc">true</span>

        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">global</span><span class="p">(</span><span class="n">qos</span><span class="p">:</span> <span class="p">.</span><span class="n">userInitiated</span><span class="p">).</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="kd">let</span> <span class="nv">self</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

            <span class="kd">let</span> <span class="nv">bufferSize</span> <span class="p">=</span> <span class="nb">Int</span><span class="p">(</span><span class="n">frameCount</span> <span class="o">*</span> <span class="n">frameSize</span><span class="p">)</span>
            <span class="kd">let</span> <span class="nv">buffer</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">byteCount</span><span class="p">:</span> <span class="n">bufferSize</span><span class="p">,</span> <span class="n">alignment</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">defer</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span> <span class="p">}</span>

            <span class="k">while</span> <span class="kc">self</span><span class="p">.</span><span class="n">isStreaming</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">performIsochronousRead</span><span class="p">(</span>
                    <span class="n">buffer</span><span class="p">:</span> <span class="n">buffer</span><span class="p">,</span>
                    <span class="n">frameCount</span><span class="p">:</span> <span class="n">frameCount</span><span class="p">,</span>
                    <span class="n">frameSize</span><span class="p">:</span> <span class="n">frameSize</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                    <span class="c1">// Calculate total bytes received</span>
                    <span class="kd">let</span> <span class="nv">totalBytes</span> <span class="p">=</span> <span class="n">frames</span><span class="p">.</span><span class="bp">reduce</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">+</span> <span class="nb">Int</span><span class="p">(</span><span class="nv">$1</span><span class="p">.</span><span class="n">frActCount</span><span class="p">)</span> <span class="p">}</span>

                    <span class="k">if</span> <span class="n">totalBytes</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">buffer</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="n">totalBytes</span><span class="p">)</span>
                        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                            <span class="n">dataHandler</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">frames</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span>
                        <span class="n">errorHandler</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="k">break</span>
                <span class="p">}</span>

                <span class="c1">// Minimal delay between transfers</span>
                <span class="n">usleep</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span> <span class="c1">// 0.5ms</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">stopIsochronousStreaming</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">isStreaming</span> <span class="p">=</span> <span class="kc">false</span>

        <span class="c1">// Abort any pending transfers</span>
        <span class="n">pipe</span><span class="p">.</span><span class="n">abort</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="complete-usage-example">Complete Usage Example</h2>
<p>Here's a comprehensive example that demonstrates how to use all the components together:</p>
<div class="highlight"><pre><span></span><code><span class="kd">import</span> <span class="nc">IOKit</span>
<span class="kd">import</span> <span class="nc">IOUSBHost</span>
<span class="kd">import</span> <span class="nc">Foundation</span>

<span class="kd">class</span> <span class="nc">USBDeviceController</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">deviceManager</span> <span class="p">=</span> <span class="n">USBDeviceManager</span><span class="p">()</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">currentDevice</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">?</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">currentInterface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Starting USB device monitoring...&quot;</span><span class="p">)</span>

        <span class="c1">// The device manager will automatically detect and process USB devices</span>
        <span class="c1">// In a real application, you would filter for specific vendor/product IDs</span>

        <span class="c1">// Keep the run loop running</span>
        <span class="n">RunLoop</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">demonstrateUSBCommunication</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">deviceManager</span><span class="p">.</span><span class="n">openDevice</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="k">defer</span> <span class="p">{</span> <span class="n">deviceManager</span><span class="p">.</span><span class="n">closeDevice</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="p">}</span>

        <span class="c1">// Set configuration (usually configuration 1)</span>
        <span class="kd">let</span> <span class="nv">setConfigResult</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">setConfiguration</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">guard</span> <span class="n">setConfigResult</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to set configuration&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">// Get first interface</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interface</span> <span class="p">=</span> <span class="n">device</span><span class="p">.</span><span class="n">interface</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to get interface&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">// Open interface</span>
        <span class="k">guard</span> <span class="n">interface</span><span class="p">.</span><span class="n">open</span><span class="p">()</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="k">else</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Failed to open interface&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="p">{</span> <span class="n">interface</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="p">}</span>

        <span class="c1">// Demonstrate control transfers</span>
        <span class="n">demonstrateControlTransfers</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">device</span><span class="p">)</span>

        <span class="c1">// Demonstrate bulk transfers (if bulk endpoints are available)</span>
        <span class="n">demonstrateBulkTransfers</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">)</span>

        <span class="c1">// Demonstrate interrupt transfers (if interrupt endpoints are available)</span>
        <span class="n">demonstrateInterruptTransfers</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">)</span>

        <span class="c1">// Demonstrate isochronous transfers (if isochronous endpoints are available)</span>
        <span class="n">demonstrateIsochronousTransfers</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">demonstrateControlTransfers</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">IOUSBHostDevice</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">=== Control Transfer Demonstration ===&quot;</span><span class="p">)</span>

        <span class="kd">let</span> <span class="nv">controlTransfer</span> <span class="p">=</span> <span class="n">USBControlTransfer</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">device</span><span class="p">)</span>

        <span class="c1">// Get device status</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">status</span> <span class="p">=</span> <span class="n">controlTransfer</span><span class="p">.</span><span class="n">getDeviceStatus</span><span class="p">()</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Device status: 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">status</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span><span class="s">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Device is self-powered&quot;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Device is bus-powered&quot;</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x02</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Remote wakeup enabled&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Example vendor-specific control transfer</span>
        <span class="c1">// This is device-specific and would need to be adapted for your device</span>
        <span class="kd">var</span> <span class="nv">vendorData</span><span class="p">:</span> <span class="nb">UInt32</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="kd">let</span> <span class="nv">vendorResult</span> <span class="p">=</span> <span class="n">controlTransfer</span><span class="p">.</span><span class="n">vendorControlTransfer</span><span class="p">(</span>
            <span class="n">direction</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// IN transfer</span>
            <span class="n">request</span><span class="p">:</span> <span class="mh">0x01</span><span class="p">,</span>   <span class="c1">// Vendor-specific request</span>
            <span class="n">value</span><span class="p">:</span> <span class="mh">0x0000</span><span class="p">,</span>
            <span class="n">index</span><span class="p">:</span> <span class="mh">0x0000</span><span class="p">,</span>
            <span class="n">data</span><span class="p">:</span> <span class="p">&amp;</span><span class="n">vendorData</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">vendorResult</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Vendor control transfer successful: 0x</span><span class="si">\(</span><span class="nb">String</span><span class="si">(</span><span class="n">vendorData</span><span class="p">,</span> <span class="n">radix</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="n">uppercase</span><span class="p">:</span> <span class="kc">true</span><span class="si">))</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">demonstrateBulkTransfers</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">=== Bulk Transfer Demonstration ===&quot;</span><span class="p">)</span>

        <span class="c1">// Find bulk endpoints</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interfaceDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">interfaceDescriptor</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="kd">var</span> <span class="nv">bulkOutEndpoint</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">?</span>
        <span class="kd">var</span> <span class="nv">bulkInEndpoint</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">?</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="p">{</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">endpointDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">endpointDescriptor</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">transferType</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span>

                <span class="k">if</span> <span class="n">transferType</span> <span class="p">==</span> <span class="mi">2</span> <span class="p">{</span> <span class="c1">// Bulk transfer</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
                        <span class="n">bulkInEndpoint</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="n">bulkOutEndpoint</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Demonstrate bulk OUT transfer</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">outEndpoint</span> <span class="p">=</span> <span class="n">bulkOutEndpoint</span><span class="p">,</span>
           <span class="kd">let</span> <span class="nv">bulkTransfer</span> <span class="p">=</span> <span class="n">USBBulkTransfer</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="n">outEndpoint</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">let</span> <span class="nv">testData</span> <span class="p">=</span> <span class="s">&quot;Hello, USB Device!&quot;</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span><span class="o">!</span>
            <span class="kd">let</span> <span class="nv">result</span> <span class="p">=</span> <span class="n">bulkTransfer</span><span class="p">.</span><span class="n">performBulkWrite</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">testData</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Bulk write successful&quot;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Demonstrate bulk IN transfer</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">inEndpoint</span> <span class="p">=</span> <span class="n">bulkInEndpoint</span><span class="p">,</span>
           <span class="kd">let</span> <span class="nv">bulkTransfer</span> <span class="p">=</span> <span class="n">USBBulkTransfer</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="n">inEndpoint</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">let</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="p">=</span> <span class="n">bulkTransfer</span><span class="p">.</span><span class="n">performBulkReadToData</span><span class="p">(</span><span class="n">maxLength</span><span class="p">:</span> <span class="mi">1024</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="p">==</span> <span class="n">kIOReturnSuccess</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">receivedData</span> <span class="p">=</span> <span class="n">data</span> <span class="p">{</span>
                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Bulk read successful: </span><span class="si">\(</span><span class="n">receivedData</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> bytes&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="kd">let</span> <span class="nv">string</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">receivedData</span><span class="p">,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="p">{</span>
                    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Received: </span><span class="si">\(</span><span class="n">string</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">demonstrateInterruptTransfers</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">=== Interrupt Transfer Demonstration ===&quot;</span><span class="p">)</span>

        <span class="c1">// Find interrupt endpoints</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interfaceDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">interfaceDescriptor</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="p">{</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">endpointDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">endpointDescriptor</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">transferType</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span>

                <span class="k">if</span> <span class="n">transferType</span> <span class="p">==</span> <span class="mi">3</span> <span class="p">{</span> <span class="c1">// Interrupt transfer</span>
                    <span class="kd">let</span> <span class="nv">isIn</span> <span class="p">=</span> <span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">isIn</span><span class="p">,</span>
                       <span class="kd">let</span> <span class="nv">interruptTransfer</span> <span class="p">=</span> <span class="n">USBInterruptTransfer</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="p">{</span>

                        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Starting continuous interrupt reading...&quot;</span><span class="p">)</span>

                        <span class="n">interruptTransfer</span><span class="p">.</span><span class="n">startContinuousReading</span><span class="p">(</span>
                            <span class="n">bufferSize</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">),</span>
                            <span class="n">dataHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span>
                                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interrupt data received: </span><span class="si">\(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> bytes&quot;</span><span class="p">)</span>
                                <span class="c1">// Process interrupt data here</span>
                            <span class="p">},</span>
                            <span class="n">errorHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
                                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Interrupt transfer error: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                        <span class="c1">// Read for 5 seconds, then stop</span>
                        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">interruptTransfer</span><span class="p">.</span><span class="n">stopContinuousReading</span><span class="p">()</span>
                            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Stopped interrupt reading&quot;</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">demonstrateIsochronousTransfers</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">IOUSBHostInterface</span><span class="p">)</span> <span class="p">{</span>
        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">=== Isochronous Transfer Demonstration ===&quot;</span><span class="p">)</span>

        <span class="c1">// Find isochronous endpoints</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">interfaceDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">interfaceDescriptor</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

        <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mf">0.</span><span class="p">.&lt;</span><span class="n">interfaceDescriptor</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="p">{</span>
            <span class="k">if</span> <span class="kd">let</span> <span class="nv">endpointDescriptor</span> <span class="p">=</span> <span class="n">interface</span><span class="p">.</span><span class="n">endpointDescriptor</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nv">transferType</span> <span class="p">=</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="mh">0x03</span>

                <span class="k">if</span> <span class="n">transferType</span> <span class="p">==</span> <span class="mi">1</span> <span class="p">{</span> <span class="c1">// Isochronous transfer</span>
                    <span class="kd">let</span> <span class="nv">isIn</span> <span class="p">=</span> <span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="n">isIn</span><span class="p">,</span>
                       <span class="kd">let</span> <span class="nv">isoTransfer</span> <span class="p">=</span> <span class="n">USBIsochronousTransfer</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">interface</span><span class="p">,</span> <span class="n">endpointAddress</span><span class="p">:</span> <span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="p">{</span>

                        <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Starting isochronous streaming...&quot;</span><span class="p">)</span>

                        <span class="n">isoTransfer</span><span class="p">.</span><span class="n">startIsochronousStreaming</span><span class="p">(</span>
                            <span class="n">frameCount</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                            <span class="n">frameSize</span><span class="p">:</span> <span class="nb">UInt32</span><span class="p">(</span><span class="n">endpointDescriptor</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">),</span>
                            <span class="n">dataHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="n">frames</span> <span class="k">in</span>
                                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Isochronous data received: </span><span class="si">\(</span><span class="n">data</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> bytes, </span><span class="si">\(</span><span class="n">frames</span><span class="p">.</span><span class="bp">count</span><span class="si">)</span><span class="s"> frames&quot;</span><span class="p">)</span>
                                <span class="c1">// Process isochronous data here (e.g., audio/video data)</span>
                            <span class="p">},</span>
                            <span class="n">errorHandler</span><span class="p">:</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
                                <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Isochronous transfer error: </span><span class="si">\(</span><span class="n">error</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
                            <span class="p">}</span>
                        <span class="p">)</span>

                        <span class="c1">// Stream for 10 seconds, then stop</span>
                        <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">isoTransfer</span><span class="p">.</span><span class="n">stopIsochronousStreaming</span><span class="p">()</span>
                            <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Stopped isochronous streaming&quot;</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">break</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Application entry point</span>
<span class="kd">let</span> <span class="nv">controller</span> <span class="p">=</span> <span class="n">USBDeviceController</span><span class="p">()</span>
<span class="n">controller</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>

<h3 id="memory-management">Memory Management</h3>
<p>Always properly manage memory allocation and deallocation:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Example of proper buffer management</span>
<span class="kd">func</span> <span class="nf">safeBufferOperation</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">size</span><span class="p">:</span> <span class="nb">Int</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="p">(</span><span class="n">UnsafeMutableRawPointer</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">)</span> <span class="kr">rethrows</span> <span class="p">-&gt;</span> <span class="n">T</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">buffer</span> <span class="p">=</span> <span class="n">UnsafeMutableRawPointer</span><span class="p">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">byteCount</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">.</span><span class="n">deallocate</span><span class="p">()</span> <span class="p">}</span>

    <span class="c1">// Zero the buffer for security</span>
    <span class="n">buffer</span><span class="p">.</span><span class="n">initializeMemory</span><span class="p">(</span><span class="k">as</span><span class="p">:</span> <span class="nb">UInt8</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">repeating</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">count</span><span class="p">:</span> <span class="n">size</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">try</span> <span class="n">operation</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="conclusion">Conclusion</h2>
<p>Apple's IOUSBHost framework provides a powerful and secure way to communicate with USB devices on macOS without the complexity and security risks of kernel extensions. By understanding when to use IOUSBHost versus DriverKit, and mastering the various transfer types and descriptor enumeration, developers can create robust applications that interact with USB devices effectively.</p>
<p>Key takeaways:</p>
<ol>
<li><strong>Use IOUSBHost for application-level USB communication</strong> where you don't need system-wide driver installation</li>
<li><strong>Master descriptor enumeration</strong> to understand device capabilities and configuration</li>
<li><strong>Choose the appropriate transfer type</strong> based on your data requirements:</li>
<li>Control transfers for device configuration</li>
<li>Bulk transfers for large data transfers</li>
<li>Interrupt transfers for periodic data</li>
<li>Isochronous transfers for time-sensitive streaming data</li>
<li><strong>Implement proper error handling</strong> and resource management</li>
<li><strong>Consider thread safety</strong> and asynchronous operations for better user experience</li>
</ol>
<p>The transition away from KEXTs represents a significant improvement in macOS security and stability, and IOUSBHost provides the tools necessary to maintain powerful USB device communication capabilities in this new paradigm.</p>
        </div>

        <!-- Neighbors -->

        <!-- Google Adsense -->

    <!-- Releated posts -->

    <!-- Comments -->
                </div>
        </main>

    </div>

    <!-- Footer -->
    <footer class="flex-shrink-0 bg-dark text-light small py-1">
        <div class="container text-center">
            &copy;  <a href="https://blogs.entropypages.in">Entropy Pages</a> by <a href="https://blogs.entropypages.in/pages/about.html">Tejus Adiga M</a>. Powered by <a href="http://getpelican.com">Pelican</a>, <a href="http://python.org">Python</a>, <a href="https://getbootstrap.com">Bootstrap 4</a><br>
            <!-- Do not remove below license sentence -->
            License: <a href="https://spdx.org/licenses/CC-BY-4.0.html">CC-BY-4.0</a>, based on <a href="https://github.com/vuquangtrong/simplify-theme">Simplify Bootstrap Theme</a>
        </div>
    </footer>

    <!-- Scripts -->
    <!--
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script>
    -->
    <script type="text/javascript" src="https://blogs.entropypages.in/theme/jquery/jquery-3.4.1.min.js"></script>
    <!--
    <script src="https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/bootstrap.min.js"></script>
    -->
    <script type="text/javascript" src="https://blogs.entropypages.in/theme/bootstrap/bootstrap.min.js"></script>
    <!--
    <script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script>
    -->
    <script type="text/javascript" src="https://blogs.entropypages.in/theme/style.js"></script>

    <!-- Sharing -->

    <!-- JSON LD -->
<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "name": "Mastering Apple's IOUSBHost Framework: Modern USB Communication on macOS and iPadOS",
    "headline": "Mastering Apple's IOUSBHost Framework: Modern USB Communication on macOS and iPadOS",
    "datePublished": "2025-06-28 10:00:00+05:30",
    "dateModified": "",
    "author": {
        "@type": "Person",
        "name": "Tejus Adiga M",
        "url": "https://blogs.entropypages.in/author/tejus-adiga-m.html"
    },
    "image": "https://blogs.entropypages.in/images/SiteImage.png",
    "url": "https://blogs.entropypages.in/mastering-apples-iousbhost-framework-modern-usb-communication-on-macos-and-ipados.html",
    "description": "A comprehensive guide to Apple's IOUSBHost framework, covering the transition from KEXTs, when to use DriverKit vs IOUSBHost, and complete implementation examples for all USB transfer types in Swift."
}
</script>
    <!-- Disqus count -->
</body>

</html>